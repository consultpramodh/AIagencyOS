{% extends "base.html" %}
{% block page_title %}Command Center{% endblock %}
{% block content %}
<section class="hero tactical">
  <div>
    <p class="eyebrow">One-Glance Daily Operations</p>
    <h2 class="hero-title">{{ ctx.tenant.name }} Command Center</h2>
    <p class="subtle">Controlled power: assess risk, clear blockers, move revenue.</p>
  </div>
  <div class="hero-actions">
    <button class="btn btn-ghost" id="focus-mode-toggle" type="button">Focus Mode</button>
    <label class="tenant-switch">Tenant
      <select class="select" onchange="window.location='/?tenant_id=' + this.value">
        {% for m in memberships %}
        <option value="{{ m.tenant_id }}" {% if m.tenant_id == ctx.tenant.id %}selected{% endif %}>Tenant {{ m.tenant_id }} ({{ m.role }})</option>
        {% endfor %}
      </select>
    </label>
  </div>
</section>

<section id="command-layout" class="command-layout">
  <aside id="intelligence-col" class="card intelligence-col">
    <div class="card-head"><h2>Intelligence Feed</h2></div>
    <div class="feed-scroll">
      {% for item in intelligence_items %}
      <button type="button" class="feed-item" data-feed-title="{{ item.title }}" data-feed-meta="{{ item.meta }}" data-feed-detail="{{ item.detail }}">
        <span class="dot {{ item.level }}"></span>
        <span class="feed-copy">
          <span class="feed-title">{{ item.title }}</span>
          <span class="feed-meta">{{ item.meta }}</span>
        </span>
      </button>
      {% else %}
      <p class="subtle">No intelligence events yet.</p>
      {% endfor %}
    </div>
  </aside>

  <div id="strategic-col" class="strategic-col">
    <section class="stats">
      <article class="stat card metric-attention"><p>Approvals Pending</p><h3>{{ approvals_pending }}</h3></article>
      <article class="stat card metric-risk"><p>Tasks Due</p><h3>{{ today_tasks|length }}</h3></article>
      <article class="stat card metric-trust"><p>Active Jobs</p><h3>{{ recent_jobs|length }}</h3></article>
    </section>

    <section class="card strategic-panel">
      <div class="card-head"><h2>Strategic Triage</h2></div>
      <ul class="triage-list">
        <li><strong>{{ today_tasks|length }}</strong> due tasks require decision sequencing.</li>
        <li><strong>{{ approvals_pending }}</strong> approvals are blocking downstream workflow steps.</li>
        <li><strong>{{ recent_runs|length }}</strong> recent runs show current automation throughput.</li>
      </ul>
    </section>

    <section id="client-grid" class="card">
      <div class="card-head"><h2>Client Power Grid</h2><a class="text-link" href="/clients?tenant_id={{ ctx.tenant.id }}">Open Clients</a></div>
      <div class="power-grid">
        {% for client in clients %}
        <article class="client-tile" data-feed-title="{{ client.name }}" data-feed-meta="Client detail" data-feed-detail="Contact: {{ client.contact_name if client.contact_name else 'not set' }}{% if client.contact_email %} · {{ client.contact_email }}{% endif %}{% if client.contact_phone %} · {{ client.contact_phone }}{% endif %}">
          <h3>{{ client.name }}</h3>
          <p>Revenue <strong>N/A</strong> · ROAS <strong>N/A</strong> · Risk <strong>Low</strong></p>
          <p>Workflows <strong>{{ recent_runs|length }}</strong> · Approvals <strong>{{ approvals_pending }}</strong></p>
          <div class="quick-actions">
            {% if client.contact_phone %}<a class="chip-link" href="tel:{{ client.contact_phone }}">Call</a>{% endif %}
            {% if client.contact_email %}<a class="chip-link" href="mailto:{{ client.contact_email }}">Email</a>{% endif %}
            {% if client.contact_phone %}<a class="chip-link" href="sms:{{ client.contact_phone }}">Text</a>{% endif %}
          </div>
        </article>
        {% else %}
        <p class="subtle">No clients yet.</p>
        {% endfor %}
      </div>
    </section>

    <section class="grid">
      <article class="card">
        <div class="card-head"><h2>Today Queue</h2><a class="text-link" href="/tasks?tenant_id={{ ctx.tenant.id }}">Open Tasks</a></div>
        <ul class="list">
          {% for task in today_tasks %}<li><span>{{ task.title }}{% if task.due_date %} ({{ task.due_date }}){% endif %}</span><span class="pill">{{ task.status|replace('_',' ')|title }}</span></li>{% else %}<li>No due tasks today</li>{% endfor %}
        </ul>
      </article>
      <article class="card">
        <div class="card-head"><h2>Upcoming Calendar</h2><a class="text-link" href="/calendar?tenant_id={{ ctx.tenant.id }}">Open Calendar</a></div>
        <ul class="list">
          {% for row in calendar_rows %}<li><span>{{ row[0] }} · {{ row[1] }}</span><span class="pill">{{ row[2] }}</span></li>{% else %}<li>No upcoming items</li>{% endfor %}
        </ul>
      </article>
      <article class="card">
        <div class="card-head"><h2>Recent Runs</h2><a class="text-link" href="/workflows?tenant_id={{ ctx.tenant.id }}">Open Workflows</a></div>
        <ul class="list">
          {% for run in recent_runs %}<li><span>Run #{{ run.id }}</span><span class="pill">{{ run.status }}</span></li>{% else %}<li>No runs yet</li>{% endfor %}
        </ul>
      </article>
    </section>
  </div>
</section>

<div id="tactical-overlay" class="overlay" hidden></div>
<aside id="tactical-panel" class="tactical-panel" aria-hidden="true">
  <div class="card-head">
    <h2 id="panel-title">Detail</h2>
    <button type="button" class="btn btn-ghost btn-small" id="panel-close">Close</button>
  </div>
  <p class="subtle" id="panel-meta"></p>
  <p id="panel-detail"></p>
</aside>

<script>
  const feedButtons = document.querySelectorAll(".feed-item, .client-tile");
  const panel = document.getElementById("tactical-panel");
  const overlay = document.getElementById("tactical-overlay");
  const title = document.getElementById("panel-title");
  const meta = document.getElementById("panel-meta");
  const detail = document.getElementById("panel-detail");
  const closeBtn = document.getElementById("panel-close");
  const focusBtn = document.getElementById("focus-mode-toggle");
  const intelligenceCol = document.getElementById("intelligence-col");
  const clientGrid = document.getElementById("client-grid");

  function openPanel(t, m, d) {
    title.textContent = t;
    meta.textContent = m;
    detail.textContent = d;
    panel.classList.add("open");
    panel.setAttribute("aria-hidden", "false");
    overlay.hidden = false;
  }

  function closePanel() {
    panel.classList.remove("open");
    panel.setAttribute("aria-hidden", "true");
    overlay.hidden = true;
  }

  feedButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      openPanel(btn.dataset.feedTitle || "Detail", btn.dataset.feedMeta || "", btn.dataset.feedDetail || "");
    });
  });

  closeBtn.addEventListener("click", closePanel);
  overlay.addEventListener("click", closePanel);

  let focusMode = false;
  focusBtn.addEventListener("click", () => {
    focusMode = !focusMode;
    document.body.classList.toggle("focus-mode", focusMode);
    intelligenceCol.style.display = focusMode ? "none" : "block";
    clientGrid.style.display = focusMode ? "none" : "block";
    focusBtn.textContent = focusMode ? "Exit Focus" : "Focus Mode";
  });
</script>
{% endblock %}
