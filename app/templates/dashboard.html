{% extends "base.html" %}
{% block page_title %}Today{% endblock %}
{% block content %}
<section class="card dashboard-controls">
  <div class="dashboard-control-group">
    <p class="eyebrow">Dashboard Scope</p>
    <div class="mode-toggle" role="group" aria-label="Dashboard mode">
      <a class="mode-chip {% if current_mode != 'client' %}active{% endif %}" href="/dashboard?tenant_id={{ ctx.tenant.id }}&mode=admin">Admin</a>
      <a class="mode-chip {% if current_mode == 'client' %}active{% endif %}" href="/dashboard?tenant_id={{ ctx.tenant.id }}&mode=client{% if selected_client %}&client_id={{ selected_client.id }}{% endif %}">Client</a>
    </div>
  </div>
  {% if current_mode == "client" %}
  <label class="tenant-switch">Client
    <select class="select" onchange="window.location='/dashboard?tenant_id={{ ctx.tenant.id }}&mode=client&client_id=' + this.value">
      <option value="">Select client</option>
      {% for client in clients %}
      <option value="{{ client.id }}" {% if selected_client and client.id == selected_client.id %}selected{% endif %}>{{ client.name }}</option>
      {% endfor %}
    </select>
  </label>
  {% endif %}
  <label class="tenant-switch">Tenant
    <select class="select" onchange="window.location='/dashboard?tenant_id=' + this.value">
      {% for m in memberships %}
      <option value="{{ m.tenant_id }}" {% if m.tenant_id == ctx.tenant.id %}selected{% endif %}>Tenant {{ m.tenant_id }} ({{ m.role }})</option>
      {% endfor %}
    </select>
  </label>
  <button class="btn btn-ghost" id="focus-mode-toggle" type="button">Focus Mode</button>
</section>

<section class="hero tactical hero-triage">
  <div>
    <p class="eyebrow">Strategic Triage</p>
    <h2 class="hero-title">
      {% if current_mode == "client" and selected_client %}
      {{ selected_client.name }} Client Dashboard
      {% else %}
      {{ ctx.tenant.name }} Admin Dashboard
      {% endif %}
    </h2>
    <p class="subtle">
      {% if current_mode == "client" and selected_client %}
      Client-specific decisions, risks, and growth levers.
      {% else %}
      Cross-client command view for agency-wide decisions, risks, and revenue.
      {% endif %}
    </p>
  </div>
  <div class="triage-numbers">
    <div><span>Decisions</span><strong>{{ decisions|length }}</strong></div>
    <div><span>Threats</span><strong>{{ threats|length }}</strong></div>
    <div><span>Opportunities</span><strong>{{ opportunities|length }}</strong></div>
  </div>
</section>

<section class="card macro-strip" data-focus-hide>
  <div class="macro-item"><span>Revenue (Month)</span><strong>${{ '%.2f' % (macro_metrics.mrr_total / 100) }}</strong><svg viewBox="0 0 80 18" aria-hidden="true"><polyline points="1,13 14,10 26,12 39,7 52,8 64,5 79,6" /></svg></div>
  <div class="macro-item"><span>Pipeline &lt;14d</span><strong>${{ '%.2f' % (macro_metrics.pipeline_14d / 100) }}</strong></div>
  <div class="macro-item"><span>Renewals</span><strong>{{ macro_metrics.renewals_soon }}</strong></div>
  <div class="macro-item"><span>Automation Load</span><strong>{{ macro_metrics.automation_load }}</strong></div>
</section>

{% if current_mode == "client" and not selected_client %}
<section class="card">
  <div class="card-head">
    <h2>Select a Client</h2>
    <a class="text-link" href="/clients?tenant_id={{ ctx.tenant.id }}">Open clients</a>
  </div>
  <p class="subtle">Pick a client in the Client mode selector to switch from agency-wide Admin dashboard to a dedicated client dashboard.</p>
</section>
{% endif %}

<section id="command-layout" class="command-layout">
  <aside id="intelligence-col" class="card intelligence-col">
    <div class="card-head">
      <h2>Intelligence Feed</h2>
      <button id="feed-mute" class="chip" type="button">Mute</button>
    </div>
    <div class="feed-controls">
      <button class="chip active" type="button" data-feed-filter="all">All</button>
      <button class="chip" type="button" data-feed-filter="fail">Failures</button>
      <button class="chip" type="button" data-feed-filter="blocked">Blocked</button>
      <button class="chip" type="button" data-feed-filter="approval">Approvals</button>
      <button class="chip" type="button" data-feed-filter="revenue">Revenue</button>
    </div>
    <div class="feed-scroll">
      {% for item in intelligence_items %}
      <button
        type="button"
        class="feed-item"
        data-feed-kind="{{ item.kind }}"
        data-feed-id="{{ item.kind }}-{{ loop.index }}-{{ item.title|replace(' ', '-') }}"
        data-quick-view
        data-title="{{ item.title }}"
        data-meta="{{ item.meta }}"
        data-details="{{ item.detail }}">
        <span class="dot {{ item.level }}"></span>
        <span class="feed-copy">
          <span class="feed-title">{{ item.title }}</span>
          <span class="feed-meta">{{ item.meta }} · {{ item.timestamp if item.timestamp else 'recent' }}</span>
        </span>
      </button>
      {% endfor %}
    </div>
  </aside>

  <div id="strategic-col" class="strategic-col">
    <section class="card">
      <div class="card-head"><h2>Decisions</h2><a class="text-link" href="/workflows?tenant_id={{ ctx.tenant.id }}">Open workflow approvals</a></div>
      <div class="decision-stack">
        {% for item in decisions %}
        <div class="decision-row">
          <div>
            <strong>{{ item.title }}: {{ item.value }}</strong>
            <span class="status-chip status-{{ item.status|lower }}">{{ item.status }}</span>
            <p>{{ item.detail }}</p>
          </div>
          {% if item.cta %}<a class="text-link" href="{{ item.cta }}">{{ item.cta_label }}</a>{% endif %}
        </div>
        {% endfor %}
      </div>
      {% if ctx.membership.role in ["owner", "admin"] %}
      <form method="post" action="/approvals?tenant_id={{ ctx.tenant.id }}" class="inline-form compact">
        <input class="input" type="text" name="title" placeholder="Add pending approval title" required />
        <button class="btn btn-small" type="submit">Add Approval</button>
      </form>
      {% endif %}
    </section>

    <section class="card" data-focus-hide>
      <div class="card-head"><h2>Threats</h2><a class="text-link" href="/workflows?tenant_id={{ ctx.tenant.id }}">Investigate</a></div>
      <div class="decision-stack">
        {% for item in threats %}
        <div class="decision-row">
          <div>
            <strong>{{ item.title }}: {{ item.value }}</strong>
            <span class="status-chip status-{{ item.status|lower }}">{{ item.status }}</span>
            <p>{{ item.detail }}</p>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>

    <section class="card" data-focus-hide>
      <div class="card-head"><h2>Opportunities</h2><a class="text-link" href="/crm?tenant_id={{ ctx.tenant.id }}">Open pipeline</a></div>
      <div class="decision-stack">
        {% for item in opportunities %}
        <div class="decision-row">
          <div>
            <strong>{{ item.title }}: {{ item.value }}</strong>
            <span class="status-chip status-{{ item.status|lower }}">{{ item.status }}</span>
            <p>{{ item.detail }}</p>
          </div>
          {% if item.cta %}<a class="text-link" href="{{ item.cta }}">{{ item.cta_label }}</a>{% endif %}
        </div>
        {% endfor %}
      </div>
    </section>

    <section class="card" id="client-grid" data-focus-hide>
      <div class="card-head"><h2>Client Power Grid</h2><a class="text-link" href="/clients?tenant_id={{ ctx.tenant.id }}">Open Clients</a></div>
      <div class="power-grid tactical-grid" data-skeleton>
        {% for tile in client_tiles %}
        <article class="client-tile">
          <div class="tile-head">
            <h3>{{ tile.name }}</h3>
            <span class="status-chip status-pass">{{ tile.status|capitalize }}</span>
          </div>
          <p>Revenue: <strong>{{ tile.revenue }}</strong> · ROAS: <strong>{{ tile.roas }}</strong></p>
          <p>Risk: <strong>{{ tile.risk }}</strong></p>
          <div class="risk-bar"><span class="risk-fill {% if tile.risk_score < 40 %}muted{% endif %}" style="width: {{ tile.risk_score if tile.risk_score else 20 }}%"></span></div>
          <p>Workflows: <strong>{{ tile.workflows }}</strong> · Approvals: <strong>{{ tile.approvals }}</strong> · Blocked: <strong>{{ tile.blocked }}</strong></p>
          <p>Pipeline: <strong>${{ '%.2f' % (tile.pipeline_value / 100) }}</strong></p>
          {% if tile.risk_drivers %}
          <p class="subtle">Drivers: {{ tile.risk_drivers|join(", ") }}</p>
          {% endif %}
          <div class="quick-actions">
            <button class="chip-link" type="button" data-client-id="{{ tile.id }}" data-quick-view data-title="{{ tile.name }}" data-meta="Client tactical quick view" data-details="Client status {{ tile.status|capitalize }}">Quick View</button>
            <a class="chip-link" href="/projects?tenant_id={{ ctx.tenant.id }}">Open Projects</a>
            <details class="chip-submenu">
              <summary class="chip-link">Contact</summary>
              <div class="chip-submenu-list">
                {% if tile.contact_phone %}<a class="chip-link" href="tel:{{ tile.contact_phone }}">Call</a>{% endif %}
                {% if tile.contact_email %}<a class="chip-link" href="mailto:{{ tile.contact_email }}">Email</a>{% endif %}
                {% if tile.contact_phone %}<a class="chip-link" href="sms:{{ tile.contact_phone }}">Text</a>{% endif %}
                {% if not tile.contact_phone and not tile.contact_email %}<span class="subtle">Add contact info</span>{% endif %}
              </div>
            </details>
          </div>
        </article>
        {% else %}
        <p class="subtle">No clients yet. Add your first client to activate tactical tiles.</p>
        {% endfor %}
      </div>
    </section>

    <section class="card" data-focus-hide>
      <div class="card-head"><h2>System Health</h2><a class="text-link" href="/calendar?tenant_id={{ ctx.tenant.id }}">Open calendar</a></div>
      <ul class="list">
        {% for row in calendar_rows %}
        <li>
          <span>{{ row[0] }} · {{ row[2] }}</span>
          <span class="status-chip status-pass">{{ row[1] }}</span>
        </li>
        {% else %}
        <li><span>No scheduled operations.</span><a class="text-link" href="/scheduler?tenant_id={{ ctx.tenant.id }}">Open scheduler</a></li>
        {% endfor %}
      </ul>
    </section>
  </div>
</section>
{% endblock %}
